"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@craftjs/utils"),t=require("react"),n=require("tiny-invariant"),r=require("lodash"),o=require("lodash/cloneDeep");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=a(t),i=a(n),s=a(o),u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function c(e,t){function n(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var l=function(){return(l=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function f(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function p(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var a=arguments[t],d=0,i=a.length;d<i;d++,o++)r[o]=a[d];return r}var v=t.createContext(null),N=function(){return t.useContext(v)},E=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.handlers=function(){return{connect:function(e,t){},select:function(e,t){},hover:function(e,t){},drag:function(e,t){},drop:function(e,t){},create:function(e,t,n){}}},t}(e.EventHandlers),h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t}(e.DerivedEventHandlers),y=function(e,t){var n=e.currentTarget,r=t.getBoundingClientRect(),o=r.top,a=r.left,d=r.width,i=r.height;if(n){var s=document.createElement("div");s.style.position="fixed",s.style.left="-100%",s.style.top="-100%",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none";var u=t.cloneNode(!0);return u.style.position="absolute",u.style.width=d+"px",u.style.height=i+"px",u.style.left=a+"px",u.style.top=o+"px",s.appendChild(u),document.body.appendChild(s),e.dataTransfer.setDragImage(s,a,o),s}},O=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentSelectedElementIds=[],t}return c(t,e),t.prototype.handlers=function(){var e=this,n=this.options.store;return{connect:function(t,r){return n.actions.setDOM(r,t),e.reflect((function(e){e.select(t,r),e.hover(t,r),e.drop(t,r)}))},select:function(t,r){var o=e.addCraftEventListener(t,"mousedown",(function(t){t.craft.stopPropagation(),e.options.store.actions.setNodeEvent("selected",r)}));return function(){n.actions.setNodeEvent("selected",null),o()}},hover:function(t,r){var o=e.addCraftEventListener(t,"mouseover",(function(e){e.craft.stopPropagation(),n.actions.setNodeEvent("hovered",r)}));return function(){n.actions.setNodeEvent("hovered",null),o()}},drop:function(r,o){var a=e.addCraftEventListener(r,"dragover",(function(e){e.craft.stopPropagation(),e.preventDefault()})),d=e.addCraftEventListener(r,"dragenter",(function(e){e.craft.stopPropagation(),e.preventDefault();var r=t.draggedElement;if(r){var a=r;r.rootNodeId&&(a=r.nodes[r.rootNodeId]);var d=n.query.getDropPlaceholder(a,o,{x:e.clientX,y:e.clientY});d&&(n.actions.setIndicator(d),t.indicator=d)}}));return function(){d(),a()}},drag:function(r,o){if(!n.query.node(o).isDraggable())return function(){};r.setAttribute("draggable","true");var a=e.addCraftEventListener(r,"dragstart",(function(e){e.craft.stopPropagation(),t.draggedElementShadow=y(e,n.query.node(o).get().dom),t.draggedElement=o})),d=e.addCraftEventListener(r,"dragend",(function(t){t.craft.stopPropagation(),e.dropElement((function(e,t){n.actions.move(e,t.parent.id,t.index+("after"===t.where?1:0))}))}));return function(){r.setAttribute("draggable","false"),a(),d()}},create:function(o,a,d){o.setAttribute("draggable","true");var i=e.addCraftEventListener(o,"dragstart",(function(e){e.craft.stopPropagation();var r=n.query.parseReactElement(a).toNodeTree();t.draggedElementShadow=y(e,e.currentTarget),t.draggedElement=r})),s=e.addCraftEventListener(o,"dragend",(function(t){t.craft.stopPropagation(),e.dropElement((function(e,t){n.actions.addNodeTree(e,t.parent.id,t.index+("after"===t.where?1:0)),d&&r.isFunction(d.onCreate)&&d.onCreate(e)}))}));return function(){o.removeAttribute("draggable"),i(),s()}}}},t.prototype.dropElement=function(e){var n=this.options.store,r=t.draggedElement,o=t.draggedElementShadow,a=t.indicator;r&&a&&!a.error&&e(r,a.placement),o&&(o.parentNode.removeChild(o),t.draggedElementShadow=null),t.draggedElement=null,t.indicator=null,n.actions.setIndicator(null),n.actions.setNodeEvent("dragged",null)},t.indicator=null,t}(E);function m(e,t,n,r){void 0===r&&(r=2);var o=0,a=0,d=0,i=0,s=e.where;return n?n.inFlow?(d=n.outerWidth,i=r,o="before"===s?n.top:n.bottom,a=n.left):(d=r,i=n.outerHeight,o=n.top,a="before"===s?n.left:n.left+n.outerWidth):t&&(o=t.top+t.padding.top,a=t.left+t.padding.left,d=t.outerWidth-t.padding.right-t.padding.left-t.margin.left-t.margin.right,i=r),{top:o+"px",left:a+"px",width:d+"px",height:i+"px"}}var g=t.createContext(null);function R(n){var r=t.useContext(g);i.default(r,e.ERROR_USE_EDITOR_OUTSIDE_OF_EDITOR_CONTEXT);var o=N(),a=e.useCollector(r,n),d=t.useMemo((function(){return o&&e.wrapConnectorHooks(o.connectors)}),[o]);return l(l({},a),{connectors:d,inContext:!!r,store:r})}var _=function(n){var r=n.children,o=R((function(e){return{enabled:e.options.enabled,indicator:e.events.indicator,indicatorOptions:e.options.indicator,handlers:e.handlers,handlersFactory:e.options.handlers,hydrationTimestamp:e.nodes.ROOT&&e.nodes.ROOT._hydrationTimestamp}})),a=o.actions,i=o.indicator,s=o.indicatorOptions,u=o.store,c=o.handlers,f=o.handlersFactory,p=o.enabled,N=o.hydrationTimestamp,E=t.useRef(u);E.current=u;var h=t.useRef(c);return h.current=c,t.useEffect((function(){return a.history.ignore().setState((function(e){return e.handlers=f(E.current)})),function(){h.current&&h.current.cleanup()}}),[a,f,N]),t.useEffect((function(){c&&(p?c.enable():c.disable())}),[p,c]),c?d.default.createElement(v.Provider,{value:c},i&&d.default.createElement(e.RenderIndicator,{style:l(l({},m(i.placement,e.getDOMInfo(i.placement.parent.dom),i.placement.currentNode&&e.getDOMInfo(i.placement.currentNode.dom),s.thickness)),{backgroundColor:i.error?s.error:s.success,transition:s.transition||"0.2s ease-in"}),parentDom:i.placement.parent.dom}),r):null},C=d.default.createContext(null),T=function(n){var r=n.id,o=n.related,a=void 0!==o&&o,i=n.children,s=N(),u=t.useMemo((function(){return e.wrapConnectorHooks({connect:function(e){return s.connectors.connect(e,r)},drag:function(e){return s.connectors.drag(e,r)}})}),[s,r]);return d.default.createElement(C.Provider,{value:{id:r,related:a,connectors:u}},i)};function b(n){var r=t.useContext(C);i.default(r,e.ERROR_USE_NODE_OUTSIDE_OF_EDITOR_CONTEXT);var o=r.id,a=r.related,d=r.connectors,s=R((function(e){return o&&e.nodes[o]&&n&&n(e.nodes[o])})),u=s.actions,c=f(s,["actions","query"]),p=t.useMemo((function(){return{setProp:function(e,t){t?u.history.throttle(t).setProp(o,e):u.setProp(o,e)},setCustom:function(e,t){t?u.history.throttle(t).setCustom(o,e):u.setCustom(o,e)},setHidden:function(e){return u.setHidden(o,e)}}}),[u,o]);return l(l({},c),{id:o,related:a,inNodeContext:!!r,actions:p,connectors:d})}function D(t){var n=b(t),r=n.id,o=n.related,a=n.actions,d=n.inNodeContext,i=n.connectors,s=f(n,["id","related","actions","inNodeContext","connectors"]);return l(l({},s),{actions:a,id:r,related:o,setProp:function(t){return e.deprecationWarning("useNode().setProp()",{suggest:"useNode().actions.setProp()"}),a.setProp(t)},inNodeContext:d,connectors:i})}var x=function(e){var t=e.render,n=D().connectors;return"string"==typeof t.type?(0,n.connect)((0,n.drag)(d.default.cloneElement(t))):t},k=function(){var e=b((function(e){return{type:e.data.type,props:e.data.props,nodes:e.data.nodes,hydrationTimestamp:e._hydrationTimestamp}})),n=e.type,r=e.props,o=e.nodes;return t.useMemo((function(){var e=r.children;o&&o.length>0&&(e=d.default.createElement(d.default.Fragment,null,o.map((function(e){return d.default.createElement(P,{id:e,key:e})}))));var t=d.default.createElement(n,r,e);return"string"==typeof n?d.default.createElement(x,{render:t}):t}),[n,r,e.hydrationTimestamp,o])},I=function(e){var t=e.render,n=b((function(e){return{hidden:e.data.hidden}})).hidden,r=R((function(e){return{onRender:e.options.onRender}})).onRender;return n?null:d.default.createElement(r,{render:t||d.default.createElement(k,null)})},P=function(e){return d.default.createElement(T,{id:e.id},d.default.createElement(I,{render:e.render}))},j={is:"div",canvas:!1,custom:{},hidden:!1},L={is:"type",canvas:"isCanvas"};function S(n){var r=n.id,o=n.children,a=f(n,["id","children"]),s=l(l({},j),a).is,u=R(),c=u.query,p=u.actions,v=b((function(e){return{node:{id:e.id,data:e.data}}})),N=v.node,E=v.inNodeContext,h=t.useState(null),y=h[0],O=h[1];return e.useEffectOnce((function(){i.default(!!r,e.ERROR_TOP_LEVEL_ELEMENT_NO_ID);var t=N.id,n=N.data;if(E){var u,l=n.linkedNodes&&n.linkedNodes[r]&&c.node(n.linkedNodes[r]).get();if(l&&l.data.type===s)u=l.id;else{var f=d.default.createElement(S,a,o),v=c.parseReactElement(f).toNodeTree();u=v.rootNodeId,p.history.ignore().addLinkedNodeFromTree(v,t,r)}O(u)}})),y?d.default.createElement(P,{id:y}):null}var A=function(){return e.deprecationWarning("<Canvas />",{suggest:"<Element canvas={true} />"})};function Canvas(e){var n=f(e,[]);return t.useEffect((function(){return A()}),[]),d.default.createElement(S,l({},n,{canvas:!0}))}var M=function(e){return f(e,["addLinkedNodeFromTree","setDOM","setNodeEvent","replaceNodes","reset"])};function w(e){var n=R(e),r=n.connectors,o=n.actions,a=f(n.query,["deserialize"]),d=n.store,i=f(n,["connectors","actions","query","store"]),s=M(o),u=t.useMemo((function(){return l(l({},s),{history:l(l({},s.history),{ignore:function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return M((e=s.history).ignore.apply(e,t))},throttle:function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return M((e=s.history).throttle.apply(e,t))}})})}),[s]);return l({connectors:r,actions:u,query:a,store:d},i)}var q=function(e){return Object.fromEntries?Object.fromEntries(e):e.reduce((function(e,t){var n,r=t[0],o=t[1];return l(l({},e),((n={})[r]=o,n))}),{})},V=function(e,t){var n=t.name||t.displayName;if(t===Canvas)return"Canvas";if(e[n])return n;for(var r=0;r<Object.keys(e).length;r++){var o=Object.keys(e)[r];if(e[o]===t)return o}return"string"==typeof t?t:void 0},H=function(e,t){return"string"==typeof e?e:{resolvedName:V(t,e)}},F=function(e,n){var r=e.type,o=e.isCanvas,a=e.props;return a=Object.keys(a).reduce((function(e,r){var o=a[r];return null==o||(e[r]="children"===r&&"string"!=typeof o?t.Children.map(o,(function(e){return"string"==typeof e?e:F(e,n)})):"function"==typeof o.type?F(o,n):o),e}),{}),{type:H(r,n),isCanvas:!!o,props:a}};function z(t,n){i.default("string"==typeof n,e.ERROR_INVALID_NODE_ID);var r=t.nodes[n],o=function(e){return z(t,e)};return{isCanvas:function(){return!!r.data.isCanvas},isRoot:function(){return r.id===e.ROOT_NODE},isLinkedNode:function(){return r.data.parent&&o(r.data.parent).linkedNodes().includes(r.id)},isTopLevelNode:function(){return this.isRoot()||this.isLinkedNode()},isDeletable:function(){return!this.isTopLevelNode()},isParentOfTopLevelNodes:function(){return r.data.linkedNodes&&Object.keys(r.data.linkedNodes).length>0},isParentOfTopLevelCanvas:function(){return e.deprecationWarning("query.node(id).isParentOfTopLevelCanvas",{suggest:"query.node(id).isParentOfTopLevelNodes"}),this.isParentOfTopLevelNodes()},get:function(){return r},ancestors:function(e){return void 0===e&&(e=!1),function n(r,o,a){void 0===o&&(o=[]),void 0===a&&(a=0);var d=t.nodes[r];return d?(o.push(r),d.data.parent?((e||!e&&0===a)&&(o=n(d.data.parent,o,a+1)),o):o):o}(r.data.parent)},descendants:function(e,r){return void 0===e&&(e=!1),function n(a,d,i){return void 0===d&&(d=[]),void 0===i&&(i=0),(e||!e&&0===i)&&t.nodes[a]?("childNodes"!==r&&o(a).linkedNodes().forEach((function(e){d.push(e),d=n(e,d,i+1)})),"linkedNodes"!==r&&o(a).childNodes().forEach((function(e){d.push(e),d=n(e,d,i+1)})),d):d}(n)},linkedNodes:function(){return Object.values(r.data.linkedNodes||{})},childNodes:function(){return r.data.nodes||[]},isDraggable:function(n){try{var a=r;return i.default(!this.isTopLevelNode(),e.ERROR_MOVE_TOP_LEVEL_NODE),i.default(z(t,a.data.parent).isCanvas(),e.ERROR_MOVE_NONCANVAS_CHILD),i.default(a.rules.canDrag(a,o),e.ERROR_CANNOT_DRAG),!0}catch(e){return n&&n(e),!1}},isDroppable:function(n,a){var d="object"==typeof n&&!t.nodes[n.id],s=function(e){return"string"==typeof e?t.nodes[e]:e}(n),u=r;try{if("string"==typeof n&&i.default(!o(n).isTopLevelNode(),e.ERROR_MOVE_TOP_LEVEL_NODE),i.default(this.isCanvas(),e.ERROR_MOVE_TO_NONCANVAS_PARENT),i.default(u.rules.canMoveIn(s,u,o),e.ERROR_MOVE_INCOMING_PARENT),i.default(s.rules.canDrop(u,s,o),e.ERROR_MOVE_CANNOT_DROP),d)return!0;var c=o(s.id).descendants(!0);i.default(!c.includes(u.id)&&u.id!==s.id,e.ERROR_MOVE_TO_DESCENDANT);var l=s.data.parent&&t.nodes[s.data.parent];return i.default(l.data.isCanvas,e.ERROR_MOVE_NONCANVAS_CHILD),i.default(l||!l&&!t.nodes[s.id],e.ERROR_DUPLICATE_NODEID),r!==l&&i.default(l.rules.canMoveOut(s,l,o),e.ERROR_MOVE_OUTGOING_PARENT),!0}catch(e){return a&&a(e),!1}},toSerializedNode:function(){return n=t.options.resolver,o=(e=r.data).type,a=e.props,d=e.isCanvas,i=f(e,["type","props","isCanvas","name"]),s=F({type:o,isCanvas:d,props:a},n),l(l({},s),i);var e,n,o,a,d,i,s},toNodeTree:function(e){var t=p([n],this.descendants(!0,e)).reduce((function(e,t){return e[t]=o(t).get(),e}),{});return{rootNodeId:n,nodes:t}},decendants:function(t){return void 0===t&&(t=!1),e.deprecationWarning("query.node(id).decendants",{suggest:"query.node(id).descendants"}),this.descendants(t)},isTopLevelCanvas:function(){return!this.isRoot()&&!r.data.parent}}}var W=function(e){return"string"==typeof e?e:e.name};function U(t,n){var r=t.data.type,o={id:t.id||e.getRandomId(),_hydrationTimestamp:Date.now(),data:l({type:r,name:W(r),displayName:W(r),props:{},custom:{},parent:null,isCanvas:!1,hidden:!1,nodes:[],linkedNodes:{}},t.data),related:{},events:{selected:!1,dragged:!1,hovered:!1},rules:{canDrag:function(){return!0},canDrop:function(){return!0},canMoveIn:function(){return!0},canMoveOut:function(){return!0}},dom:null};if(o.data.type===S||o.data.type===Canvas){var a=l(l({},j),o.data.props);o.data.props=Object.keys(o.data.props).reduce((function(e,t){return Object.keys(j).includes(t)?o.data[L[t]||t]=a[t]:e[t]=o.data.props[t],e}),{}),o.data.name=W(r=o.data.type),o.data.displayName=W(r),o.data.type===Canvas&&(o.data.isCanvas=!0,A())}n&&n(o);var i=r.craft;if(i&&(o.data.displayName=i.displayName||i.name||o.data.displayName,o.data.props=l(l({},i.props||i.defaultProps||{}),o.data.props),o.data.custom=l(l({},i.custom||{}),o.data.custom),null!=i.isCanvas&&(o.data.isCanvas=i.isCanvas),i.rules&&Object.keys(i.rules).forEach((function(e){["canDrag","canDrop","canMoveIn","canMoveOut"].includes(e)&&(o.rules[e]=i.rules[e])})),i.related)){var s={id:o.id,related:!0};Object.keys(i.related).forEach((function(e){o.related[e]=function(){return d.default.createElement(T,s,d.default.createElement(i.related[e]))}}))}return o}var G=function(e,t,n){var r=e.props,o=function(e,t){return"object"==typeof e&&e.resolvedName?"Canvas"===e.resolvedName?Canvas:t[e.resolvedName]:"string"==typeof e?e:null}(e.type,t);if(o){r=Object.keys(r).reduce((function(e,n){var o=r[n];return e[n]=null==o?null:"object"==typeof o&&o.resolvedName?G(o,t):"children"===n&&Array.isArray(o)?o.map((function(e){return"string"==typeof e?e:G(e,t)})):o,e}),{}),n&&(r.key=n);var a=l({},d.default.createElement(o,l({},r)));return l(l({},a),{name:V(t,a.type)})}},B=function(e,t){var n,r;if(t.length<1)return(n={})[e.id]=e,n;var o=t.map((function(e){return e.rootNodeId})),a=l(l({},e),{data:l(l({},e.data),{nodes:o})}),d=((r={})[e.id]=a,r);return t.reduce((function(t,n){var r,o=n.nodes[n.rootNodeId];return l(l(l({},t),n.nodes),((r={})[o.id]=l(l({},o),{data:l(l({},o.data),{parent:e.id})}),r))}),d)};function J(n){var r=n&&n.options,o=function(){return J(n)};return{getDropPlaceholder:function(t,r,a,d){if(void 0===d&&(d=function(e){return n.nodes[e.id].dom}),t!==r){var i="string"==typeof t&&n.nodes[t],s=n.nodes[r],u=o().node(s.id).isCanvas()?s:n.nodes[s.data.parent];if(u){var c=u.data.nodes||[],f=function(e,t,n,r){for(var o={parent:e,index:0,where:"before"},a=0,d=0,i=0,s=0,u=0,c=0,l=0,f=t.length;l<f;l++){var p=t[l];if(c=p.top+p.outerHeight,s=p.left+p.outerWidth/2,u=p.top+p.outerHeight/2,!(d&&p.left>d||i&&u>=i||a&&p.left+p.outerWidth<a))if(o.index=l,p.inFlow){if(r<u){o.where="before";break}o.where="after"}else r<c&&(i=c),n<s?(d=s,o.where="before"):(a=s,o.where="after")}return o}(u,c?c.reduce((function(t,r){var o=d(n.nodes[r]);if(o){var a=l({id:r},e.getDOMInfo(o));t.push(a)}return t}),[]):[],a.x,a.y),p=c.length&&n.nodes[c[f.index]],v={placement:l(l({},f),{currentNode:p}),error:!1};return i&&o().node(i.id).isDraggable((function(e){return v.error=e})),o().node(u.id).isDroppable(t,(function(e){return v.error=e})),v}}},getOptions:function(){return r},node:function(e){return z(n,e)},getSerializedNodes:function(){var e=this,t=Object.keys(n.nodes).map((function(t){return[t,e.node(t).toSerializedNode()]}));return q(t)},serialize:function(){return JSON.stringify(this.getSerializedNodes())},parseReactElement:function(r){return{toNodeTree:function(a){var s=function(e,n){var r=e;return"string"==typeof r&&(r=d.default.createElement(t.Fragment,{},r)),U({data:{type:r.type,props:l({},r.props)}},(function(e){n&&n(e,r)}))}(r,(function(t,r){var o=V(n.options.resolver,t.data.type);i.default(null!==o,e.ERROR_NOT_IN_RESOLVER),t.data.displayName=t.data.displayName||o,t.data.name=o,a&&a(t,r)})),u=[];return r.props&&r.props.children&&(u=d.default.Children.toArray(r.props.children).reduce((function(e,t){return d.default.isValidElement(t)&&e.push(o().parseReactElement(t).toNodeTree(a)),e}),[])),function(e,t){return{rootNodeId:e.id,nodes:B(e,t)}}(s,u)}}},parseSerializedNode:function(t){return{toNode:function(r){var a=function(t,n){var r=t.type,o=f(t,["type","props"]);i.default(void 0!==r&&"string"==typeof r||void 0!==r&&void 0!==r.resolvedName,e.ERROR_DESERIALIZE_COMPONENT_NOT_IN_RESOLVER.replace("%displayName%",t.displayName).replace("%availableComponents%",Object.keys(n).join(", ")));var a=G(t,n),d=a.name;return{type:a.type,name:d,displayName:o.displayName||d,props:a.props,custom:o.custom||{},isCanvas:!!o.isCanvas,hidden:!!o.hidden,parent:o.parent,linkedNodes:o.linkedNodes||o._childCanvas||{},nodes:o.nodes||[]}}(t,n.options.resolver);i.default(a.type,e.ERROR_NOT_IN_RESOLVER);var d="string"==typeof r&&r;return d&&e.deprecationWarning("query.parseSerializedNode(...).toNode(id)",{suggest:"query.parseSerializedNode(...).toNode(node => node.id = id)"}),o().parseFreshNode(l(l({},d?{id:d}:{}),{data:a})).toNode(!d&&r)}}},parseFreshNode:function(t){return{toNode:function(r){return U(t,(function(t){t.data.parent===e.DEPRECATED_ROOT_NODE&&(t.data.parent=e.ROOT_NODE);var o=V(n.options.resolver,t.data.type);i.default(null!==o,e.ERROR_NOT_IN_RESOLVER),t.data.displayName=t.data.displayName||o,t.data.name=o,r&&r(t)}))}}},createNode:function(t,n){e.deprecationWarning("query.createNode("+t+")",{suggest:"query.parseReactElement("+t+").toNodeTree()"});var r=this.parseReactElement(t).toNodeTree(),o=r.nodes[r.rootNodeId];return n?(n.id&&(o.id=n.id),n.data&&(o.data=l(l({},o.data),n.data)),o):o},getState:function(){return n}}}var X={nodes:{},events:{dragged:null,selected:null,hovered:null,indicator:null},handlers:null,options:{onNodesChange:function(){return null},onRender:function(e){return e.render},resolver:{},enabled:!0,indicator:{error:"red",success:"rgb(98, 196, 98)"},handlers:function(e){return new O({store:e})}}},Q={methods:function(t,n){return l(l({},function(t,n){var r=function(n,r,a){var d=function(e,r){var o=n.nodes[e];t.nodes[e]=l(l({},o),{data:l(l({},o.data),{parent:r})}),o.data.nodes.length>0&&(delete t.nodes[e].data.props.children,o.data.nodes.forEach((function(e){return d(e,o.id)}))),Object.values(o.data.linkedNodes).forEach((function(e){return d(e,o.id)}))};if(d(n.rootNodeId,r),r){var s=o(r);if("child"!==a.type)s.data.linkedNodes[a.id]=n.rootNodeId;else{var u=a.index;null!=u?s.data.nodes.splice(u,0,n.rootNodeId):s.data.nodes.push(n.rootNodeId)}}else i.default(n.rootNodeId===e.ROOT_NODE,"Cannot add non-root Node without a parent")},o=function(n){i.default(n,e.ERROR_NOPARENT);var r=t.nodes[n];return i.default(r,e.ERROR_INVALID_NODEID),r},a=function(e){var n=t.nodes[e],r=t.nodes[n.data.parent];if(n.data.nodes&&p(n.data.nodes).forEach((function(e){return a(e)})),n.data.linkedNodes&&Object.values(n.data.linkedNodes).map((function(e){return a(e)})),r.data.nodes.includes(e)){var o=r.data.nodes;o.splice(o.indexOf(e),1)}else{var d=Object.keys(r.data.linkedNodes).find((function(e){return r.data.linkedNodes[e]===e}));d&&delete r.data.linkedNodes[d]}!function(e,t){Object.keys(e.events).forEach((function(n){e.events[n]&&e.events[n]===t&&(e.events[n]=null)}))}(t,e),delete t.nodes[e]};return{addLinkedNodeFromTree:function(e,t,n){var d=o(t).data.linkedNodes[n];d&&a(d),r(e,t,{type:"linked",id:n})},add:function(t,n,o){var a=[t];Array.isArray(t)&&(e.deprecationWarning("actions.add(node: Node[])",{suggest:"actions.add(node: Node)"}),a=t),a.forEach((function(e){var t;r({nodes:(t={},t[e.id]=e,t),rootNodeId:e.id},n,{type:"child",index:o})}))},addNodeTree:function(e,t,n){r(e,t,{type:"child",index:n})},delete:function(t){i.default(!n.node(t).isTopLevelNode(),e.ERROR_DELETE_TOP_LEVEL_NODE),a(t)},deserialize:function(t){var r="string"==typeof t?JSON.parse(t):t,o=Object.keys(r).map((function(t){var o=t;return t===e.DEPRECATED_ROOT_NODE&&(o=e.ROOT_NODE),[o,n.parseSerializedNode(r[t]).toNode((function(e){return e.id=o}))]}));this.replaceNodes(q(o))},move:function(e,r,o){var a=t.nodes[e],d=a.data.parent,i=t.nodes[r].data.nodes;n.node(r).isDroppable(a,(function(e){throw new Error(e)}));var s=t.nodes[d].data.nodes;s[s.indexOf(e)]="marked",i.splice(o,0,e),t.nodes[e].data.parent=r,s.splice(s.indexOf("marked"),1)},replaceNodes:function(e){this.clearEvents(),t.nodes=e},clearEvents:function(){this.setNodeEvent("selected",null),this.setNodeEvent("hovered",null),this.setNodeEvent("dragged",null),this.setIndicator(null)},reset:function(){this.clearEvents(),this.replaceNodes({})},setOptions:function(e){e(t.options)},setNodeEvent:function(e,n){var r=t.events[e];r&&n!==r&&(t.nodes[r].events[e]=!1),n?(t.nodes[n].events[e]=!0,t.events[e]=n):t.events[e]=null},setCustom:function(e,n){n(t.nodes[e].data.custom)},setDOM:function(e,n){t.nodes[e]&&(t.nodes[e].dom=n)},setIndicator:function(e){e&&(!e.placement.parent.dom||e.placement.currentNode&&!e.placement.currentNode.dom)||(t.events.indicator=e)},setHidden:function(e,n){t.nodes[e].data.hidden=n},setProp:function(n,r){i.default(t.nodes[n],e.ERROR_INVALID_NODEID),r(t.nodes[n].data.props)},selectNode:function(e){this.setNodeEvent("selected",null!=e?e:null),this.setNodeEvent("hovered",null)}}}(t,n)),{setState:function(e){var n=f(this,["history"]);e(t,n)}})},ignoreHistoryForActions:["setDOM","setNodeEvent","selectNode","clearEvents","setOptions","setIndicator"],normalizeHistory:function(e){Object.keys(e.events).forEach((function(t){var n=e.events[t];n&&!e.nodes[n]&&(e.events[t]=null)})),Object.keys(e.nodes).forEach((function(t){var n=e.nodes[t];Object.keys(n.events).forEach((function(t){n.events[t]&&e.events[t]&&e.events[t]!==n.id&&(n.events[t]=!1)}))}))}},Y=function(t){return e.useMethods(Q,l(l({},X),{options:l(l({},X.options),t)}),J)},Z=function(e){var t=e.events,n=e.data,r=n.nodes,o=n.linkedNodes,a=f(e,["events","data"]),d=U(s.default(e));return{node:e=l(l(l({},d),a),{events:l(l({},d.events),t),dom:e.dom||d.dom}),childNodes:r,linkedNodes:o}},K=function(e){var t={},n=function(e){var r=Z(e),o=r.node,a=r.childNodes,d=r.linkedNodes;t[o.id]=o,a&&a.forEach((function(e,r){var a=Z(e),d=a.node,i=a.childNodes,s=a.linkedNodes;d.data.parent=o.id,t[d.id]=d,o.data.nodes[r]=d.id,n(l(l({},d),{data:l(l({},d.data),{nodes:i||[],linkedNodes:s||{}})}))})),d&&Object.keys(d).forEach((function(e){var r=Z(d[e]),a=r.node,i=r.childNodes,s=r.linkedNodes;o.data.linkedNodes[e]=a.id,a.data.parent=o.id,t[a.id]=a,n(l(l({},a),{data:l(l({},a.data),{nodes:i||[],linkedNodes:s||{}})}))}))};return n(e),t};Object.defineProperty(exports,"ROOT_NODE",{enumerable:!0,get:function(){return e.ROOT_NODE}}),exports.ActionMethodsWithConfig=Q,exports.Canvas=Canvas,exports.CoreEventHandlers=E,exports.DefaultEventHandlers=O,exports.DerivedCoreEventHandlers=h,exports.Editor=function(n){var o=n.children,a=n.onRender,s=n.onNodesChange,u=n.resolver,c=n.enabled,l=n.indicator;void 0!==u&&i.default("object"==typeof u&&!Array.isArray(u),e.ERROR_RESOLVER_NOT_AN_OBJECT);var f=t.useMemo((function(){return r.pickBy({onRender:a,onNodesChange:s,resolver:u,enabled:c,indicator:l},(function(e){return void 0!==e}))}),[c,l,s,a,u]),p=Y(f);return t.useEffect((function(){p&&f&&p.actions.setOptions((function(e){Object.assign(e,f)}))}),[p,f]),t.useEffect((function(){p.subscribe((function(e){return{json:p.query.serialize()}}),(function(){p.query.getOptions().onNodesChange(p.query)}))}),[p]),p?d.default.createElement(g.Provider,{value:p},d.default.createElement(_,null,o)):null},exports.Element=S,exports.Events=_,exports.Frame=function(n){var r=n.children,o=n.json,a=n.data,i=R(),s=i.actions,u=i.query,c=t.useState(null),l=c[0],f=c[1];o&&e.deprecationWarning("<Frame json={...} />",{suggest:"<Frame data={...} />"});var p=t.useRef({initialChildren:r,initialData:a||o});return t.useEffect((function(){var t=p.current,n=t.initialChildren,r=t.initialData;if(r)s.history.ignore().deserialize(r);else if(n){var o=d.default.Children.only(n),a=u.parseReactElement(o).toNodeTree((function(t,n){return n===o&&(t.id=e.ROOT_NODE),t}));s.history.ignore().addNodeTree(a)}f(d.default.createElement(P,{id:e.ROOT_NODE}))}),[s,u]),l},exports.NodeElement=P,exports.NodeHelpers=z,exports.NodeProvider=T,exports.QueryMethods=J,exports.connectEditor=function(e){return function(t){return function(n){var r=e?w(e):w();return d.default.createElement(t,l({},r,n))}}},exports.connectNode=function(e){return function(t){return function(n){var r=D(e);return d.default.createElement(t,l({},r,n))}}},exports.createTestNodes=K,exports.createTestState=function(e){void 0===e&&(e={});var t=e.nodes,n=e.events;return l(l(l({},X),e),{nodes:t?K(t):{},events:l(l({},X.events),n||{})})},exports.defaultElementProps=j,exports.deprecateCanvasComponent=A,exports.editorInitialState=X,exports.elementPropToNodeData=L,exports.expectEditorState=function(e,t){var n=t.nodes,r=f(t,["nodes"]),o=e.nodes,a=f(e,["nodes"]);expect(a).toEqual(r);var d=Object.keys(n).reduce((function(e,t){var r=f(n[t],["_hydrationTimestamp","rules"]);return e[t]=r,e}),{}),i=Object.keys(o).reduce((function(e,t){var n=f(o[t],["_hydrationTimestamp","rules"]);return e[t]=n,e}),{});expect(i).toEqual(d)},exports.useEditor=w,exports.useEditorStore=Y,exports.useEventHandler=N,exports.useNode=D;
